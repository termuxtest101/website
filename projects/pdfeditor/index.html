<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PDF Editor â€“ GDrive Sync</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.2/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/idb-keyval.iife.min.js"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    html{font-family:Roboto,Helvetica,Arial,sans-serif}
    canvas{touch-action:none}
    #viewer{touch-action:pan-x pan-y}
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
<div class="p-4 space-y-2">
  <div class="flex justify-between items-center">
    <h1 class="text-xl font-bold">ðŸ“„ PDF Editor â€“ Google Drive Sync</h1>
    <button id="gSign" class="px-3 py-1 bg-red-500 text-white rounded">Sign&nbsp;Google</button>
  </div>

  <div class="flex flex-wrap gap-2 mb-2">
    <button id="importDrv" class="px-3 py-2 bg-blue-600 text-white rounded">ðŸ“‚ Import&nbsp;Drive</button>
    <button id="exportDrv" class="px-3 py-2 bg-green-600 text-white rounded">ðŸ’¾ Export&nbsp;Drive</button>
    <button id="chooseBtn" class="px-3 py-2 bg-gray-300 rounded">ðŸ“„ Local&nbsp;PDF</button>
    <input id="fileInput" type="file" accept="application/pdf" class="hidden" />
  </div>

  <!-- Viewer -->
  <div id="viewer" class="relative w-full h-[80vh] flex justify-center bg-white shadow rounded overflow-auto">
    <canvas id="pdfCanvas"></canvas>
    <canvas id="overlayCanvas" class="absolute inset-0"></canvas>
  </div>
</div>

<script>
/* ================= GOOGLE DRIVE AUTH ================= */
const CLIENT_ID = '231781629245-dr7b48ufcp67um90ip7g56d571skesp5.apps.googleusercontent.com'; // <-- replace
const SCOPES = 'https://www.googleapis.com/auth/drive.file';
let gAuth;
function initGoogle(){
  gapi.load('client:auth2',async()=>{
    await gapi.client.init({clientId:CLIENT_ID,scope:SCOPES});
    gAuth=gapi.auth2.getAuthInstance();
    if(gAuth.isSignedIn.get()) document.getElementById('gSign').classList.add('bg-green-500');
  });
}
window.addEventListener('load',initGoogle);
$('gSign').onclick=async()=>{try{await gAuth.signIn();alert('Google Connected');$('gSign').classList.add('bg-green-500');}catch(e){console.error(e);}};
function token(){return gAuth?.currentUser.get().getAuthResponse().access_token;}

/* ================= BASIC EDITOR STATE (simplified) ================= */
const pdfCanvas=$('pdfCanvas'),overlay=$('overlayCanvas'),ctxO=overlay.getContext('2d');
let original=null,pdfDoc=null,page=1,pages=0,scale=1.0,currentFilename='';
const annotations=[]; // bare-min for demo
/* ---- helpers ---- */
function $(id){return document.getElementById(id);}const buf2b64=b=>btoa(String.fromCharCode(...new Uint8Array(b)));const b642buf=b=>Uint8Array.from(atob(b),c=>c.charCodeAt(0)).buffer;

/* ==================== LOAD LOCAL PDF ==================== */
$('chooseBtn').onclick=()=>$('fileInput').click();
$('fileInput').onchange=e=>e.target.files[0]&&loadArrayBuffer(e.target.files[0].arrayBuffer(), e.target.files[0].name);
async function loadArrayBuffer(promise, name='') { original = await promise; currentFilename = name;pdfDoc=await pdfjsLib.getDocument({data:original}).promise;pages=pdfDoc.numPages;page=1;render();}

/* ==================== RENDER ==================== */
async function render(){if(!pdfDoc)return;const p=await pdfDoc.getPage(page);const vp=p.getViewport({scale});pdfCanvas.width=vp.width;pdfCanvas.height=vp.height;overlay.width=vp.width;overlay.height=vp.height;await p.render({canvasContext:pdfCanvas.getContext('2d'),viewport:vp}).promise;ctxO.clearRect(0,0,overlay.width,overlay.height);} // no annotations for brevity

/* ==================== GOOGLE DRIVE IMPORT ==================== */
$('importDrv').onclick=async()=>{
 if(!gAuth||!gAuth.isSignedIn.get())return alert('Sign in first');
 const list=await gapi.client.drive.files.list({q:"mimeType='application/pdf' and trashed=false",pageSize:20,fields:'files(id,name)'});
 const files=list.result.files;if(!files.length)return alert('No PDFs found');
 const choice=prompt('Enter number to import:\n'+files.map((f,i)=>`${i+1}. ${f.name}`).join('\n'));
 const idx=parseInt(choice)-1;if(idx<0||idx>=files.length)return;
 const id=files[idx].id;const res=await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`,{headers:{Authorization:'Bearer '+token()}});const buf=await res.arrayBuffer();loadArrayBuffer(Promise.resolve(buf), files[idx].name);};

/* ==================== GOOGLE DRIVE EXPORT ==================== */
$('exportDrv').onclick=async()=>{
 if(!original)return alert('No PDF loaded');
 if(!gAuth||!gAuth.isSignedIn.get())return alert('Sign in first');
 const blob=new Blob([original],{type:'application/pdf'});
 await uploadNew(blob, currentFilename || 'Edited-PDF.pdf');
};
async function uploadNew(blob,name){const meta={name,mimeType:'application/pdf'};const boundary='-------314159';const deli=`\r\n--${boundary}\r\n`;const close=`\r\n--${boundary}--`;const reader=new FileReader();reader.onload=async()=>{
 const body=deli+'Content-Type: application/json; charset=UTF-8\r\n\r\n'+JSON.stringify(meta)+deli+'Content-Type: application/pdf\r\n\r\n'+reader.result+close;
 await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',{method:'POST',headers:{'Authorization':'Bearer '+token(),'Content-Type':'multipart/related; boundary='+boundary},body});alert('Uploaded');};reader.readAsBinaryString(blob);}  

/* ==================== AUTOSAVE WIP TO DRIVE ==================== */
async function syncWIP(bytes){if(!gAuth||!gAuth.isSignedIn.get())return;const idKey='wipFileId';let fid=localStorage.getItem(idKey);const blob=new Blob([bytes],{type:'application/pdf'});
 if(!fid){fid=await uploadNewReturnId(blob,'PDF-Editor-WIP.pdf');localStorage.setItem(idKey,fid);}else{await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fid}?uploadType=media`,{method:'PATCH',headers:{'Authorization':'Bearer '+token(),'Content-Type':'application/pdf'},body:blob});}}
async function uploadNewReturnId(blob,name){const meta={name,mimeType:'application/pdf'};const boundary='-------314159';const deli=`\r\n--${boundary}\r\n`;const close=`\r\n--${boundary}--`;return new Promise(res=>{const r=new FileReader();r.onload=async()=>{const body=deli+'Content-Type: application/json; charset=UTF-8\r\n\r\n'+JSON.stringify(meta)+deli+'Content-Type: application/pdf\r\n\r\n'+r.result+close;const resp=await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',{method:'POST',headers:{'Authorization':'Bearer '+token(),'Content-Type':'multipart/related; boundary='+boundary},body});const j=await resp.json();res(j.id);};r.readAsBinaryString(blob);});}

</script>
</body>
</html>