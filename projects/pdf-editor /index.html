<!DOCTYPE html><html lang="en">
    <head>
      <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
          <title>PDF Editor â€“ Color Picker Edition</title>
            <!-- TailwindCSS -->
              <script src="https://cdn.tailwindcss.com"></script>
                <!-- Google Fonts -->
                  <link rel="preconnect" href="https://fonts.googleapis.com" />
                    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
                      <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
                        <!-- pdf.js -->
                          <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
                            <!-- pdfâ€‘lib -->
                              <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
                                <!-- SignaturePad -->
                                  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.2/dist/signature_pad.umd.min.js"></script>
                                    <!-- idbâ€‘keyval (IndexedDB) -->
                                      <script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/idb-keyval.iife.min.js"></script>
                                        <style>
                                            html { font-family: Roboto, Helvetica, Arial, sans-serif; }
                                                canvas { touch-action: none; }
                                                  </style>
                                                  </head>
                                                  <body class="bg-gray-100 min-h-screen flex flex-col">
                                                    <div class="container mx-auto flex-1 p-4 space-y-4">
                                                        <h1 class="text-xl font-bold text-center">ðŸ“„ PDF Editor â€“ Dragâ€‘Drop â€¢ Undo/Redo â€¢ Fonts â€¢ Colors</h1><!-- Controls Row 1 -->
                                                        <div class="flex flex-wrap gap-2">
                                                          <button id="chooseBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md">Choose PDF</button>
                                                            <input type="file" id="fileInput" accept="application/pdf" class="hidden" />
                                                              <button id="prevBtn" class="px-4 py-2 bg-gray-300 rounded-md" disabled>Prev</button>
                                                                <button id="nextBtn" class="px-4 py-2 bg-gray-300 rounded-md" disabled>Next</button>
                                                                  <button id="undoBtn" class="px-4 py-2 bg-gray-300 rounded-md" disabled>Undo</button>
                                                                    <button id="redoBtn" class="px-4 py-2 bg-gray-300 rounded-md" disabled>Redo</button>
                                                                      <button id="addTextBtn" class="px-4 py-2 bg-green-600 text-white rounded-md" disabled>Add Text</button>
                                                                        <button id="signBtn" class="px-4 py-2 bg-yellow-500 text-white rounded-md" disabled>Add Signature</button>
                                                                          <button id="saveBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md" disabled>Save PDF</button>
                                                                          </div>

                                                                          <!-- Controls Row 2: Style -->
                                                                          <div id="textStyleBar" class="flex flex-wrap gap-2 items-center opacity-50 pointer-events-none transition-opacity">
                                                                            <label class="flex items-center gap-1">Font:
                                                                                <select id="fontSelect" class="border rounded px-2 py-1 text-sm">
                                                                                      <option value="Roboto">Roboto</option>
                                                                                            <option value="Montserrat">Montserrat</option>
                                                                                                  <option value="Helvetica">Helvetica</option>
                                                                                                      </select>
                                                                                                        </label>
                                                                                                          <label class="flex items-center gap-1">Size:
                                                                                                              <input type="number" id="fontSizeInput" min="8" max="72" value="16" class="border rounded w-20 px-2 py-1 text-sm">
                                                                                                                </label>
                                                                                                                  <label class="flex items-center gap-1"><input type="checkbox" id="boldCheck"> <span class="text-sm">Bold</span></label>
                                                                                                                    <label class="flex items-center gap-1"><input type="checkbox" id="underlineCheck"> <span class="text-sm">Underline</span></label>
                                                                                                                      <label class="flex items-center gap-1"><input type="checkbox" id="highlightCheck"> <span class="text-sm">Highlight</span></label>
                                                                                                                        <label class="flex items-center gap-1">Text Color <input type="color" id="textColorInput" value="#000000" class="w-8 h-8 p-0 border rounded"></label>
                                                                                                                          <label class="flex items-center gap-1">Underline Color <input type="color" id="underlineColorInput" value="#000000" class="w-8 h-8 p-0 border rounded"></label>
                                                                                                                            <label class="flex items-center gap-1">Highlight Color <input type="color" id="highlightColorInput" value="#ffff00" class="w-8 h-8 p-0 border rounded"></label>
                                                                                                                            </div>

                                                                                                                            <!-- Viewer / Drop zone -->
                                                                                                                            <div id="viewer" class="relative w-full flex justify-center bg-white shadow rounded-md overflow-auto border-dashed border-2 border-transparent transition-colors">
                                                                                                                              <canvas id="pdfCanvas"></canvas>
                                                                                                                                <canvas id="overlayCanvas" class="absolute inset-0"></canvas>
                                                                                                                                  <div id="dropHint" class="absolute inset-0 flex items-center justify-center text-gray-400 text-lg pointer-events-none hidden">Drop PDF here</div>
                                                                                                                                  </div>

                                                                                                                                  <!-- Signature Modal -->
                                                                                                                                  <div id="sigModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                                                                                                                                    <div class="bg-white p-4 rounded-lg shadow-lg w-11/12 sm:w-96 space-y-2">
                                                                                                                                        <h2 class="text-lg font-semibold">Draw your signature</h2>
                                                                                                                                            <canvas id="sigPad" class="border w-full h-48"></canvas>
                                                                                                                                                <div class="flex justify-between">
                                                                                                                                                      <button id="clearSig" class="px-3 py-1 bg-gray-300 rounded">Clear</button>
                                                                                                                                                            <div class="space-x-2">
                                                                                                                                                                    <button id="cancelSig" class="px-3 py-1 bg-red-500 text-white rounded">Cancel</button>
                                                                                                                                                                            <button id="saveSig" class="px-3 py-1 bg-green-600 text-white rounded">Save</button>
                                                                                                                                                                                  </div>
                                                                                                                                                                                      </div>
                                                                                                                                                                                        </div>
                                                                                                                                                                                        </div>

                                                                                                                                                                                          </div>  <script>
                                                                                                                                                                                              /* --------------------------------------------------
                                                                                                                                                                                                     Helpers
                                                                                                                                                                                                         -------------------------------------------------- */
                                                                                                                                                                                                             const hexToRgb = (hex) => {
                                                                                                                                                                                                                   const h = hex.replace('#', '');
                                                                                                                                                                                                                         const bigint = parseInt(h, 16);
                                                                                                                                                                                                                               const r = (bigint >> 16) & 255;
                                                                                                                                                                                                                                     const g = (bigint >> 8) & 255;
                                                                                                                                                                                                                                           const b = bigint & 255;
                                                                                                                                                                                                                                                 return { r: r / 255, g: g / 255, b: b / 255 };
                                                                                                                                                                                                                                                     };
                                                                                                                                                                                                                                                         const buf2b64 = (buf) => btoa(String.fromCharCode(...new Uint8Array(buf)));
                                                                                                                                                                                                                                                             const b642buf = (b64) => Uint8Array.from(atob(b64), c => c.charCodeAt(0)).buffer;

                                                                                                                                                                                                                                                                 /* --------------------------------------------------
                                                                                                                                                                                                                                                                        State & Constants
                                                                                                                                                                                                                                                                            -------------------------------------------------- */
                                                                                                                                                                                                                                                                                const STORAGE_KEY = 'pdfEditorAutosaveV3';
                                                                                                                                                                                                                                                                                    const FONT_URLS = {
                                                                                                                                                                                                                                                                                          Roboto: {
                                                                                                                                                                                                                                                                                                  regular: 'https://cdn.jsdelivr.net/npm/@fontsource/roboto/files/roboto-latin-400-normal.ttf',
                                                                                                                                                                                                                                                                                                          bold: 'https://cdn.jsdelivr.net/npm/@fontsource/roboto/files/roboto-latin-700-normal.ttf',
                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                      Montserrat: {
                                                                                                                                                                                                                                                                                                                              regular: 'https://cdn.jsdelivr.net/npm/@fontsource/montserrat/files/montserrat-latin-400-normal.ttf',
                                                                                                                                                                                                                                                                                                                                      bold: 'https://cdn.jsdelivr.net/npm/@fontsource/montserrat/files/montserrat-latin-700-normal.ttf',
                                                                                                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                                                                                                                };

                                                                                                                                                                                                                                                                                                                                                    let pdfDoc = null;
                                                                                                                                                                                                                                                                                                                                                        let originalBytes = null;
                                                                                                                                                                                                                                                                                                                                                            let currentPage = 1;
                                                                                                                                                                                                                                                                                                                                                                let totalPages = 0;
                                                                                                                                                                                                                                                                                                                                                                    const scale = 1.2;

                                                                                                                                                                                                                                                                                                                                                                        const annotations = [];
                                                                                                                                                                                                                                                                                                                                                                            const signatures = [];
                                                                                                                                                                                                                                                                                                                                                                                const undoStack = [];
                                                                                                                                                                                                                                                                                                                                                                                    const redoStack = [];

                                                                                                                                                                                                                                                                                                                                                                                        /* --------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                               DOM Refs
                                                                                                                                                                                                                                                                                                                                                                                                   -------------------------------------------------- */
                                                                                                                                                                                                                                                                                                                                                                                                       const chooseBtn = document.getElementById('chooseBtn');
                                                                                                                                                                                                                                                                                                                                                                                                           const fileInput = document.getElementById('fileInput');
                                                                                                                                                                                                                                                                                                                                                                                                               const viewer = document.getElementById('viewer');
                                                                                                                                                                                                                                                                                                                                                                                                                   const dropHint = document.getElementById('dropHint');
                                                                                                                                                                                                                                                                                                                                                                                                                       const pdfCanvas = document.getElementById('pdfCanvas');
                                                                                                                                                                                                                                                                                                                                                                                                                           const overlayCanvas = document.getElementById('overlayCanvas');
                                                                                                                                                                                                                                                                                                                                                                                                                               const overlayCtx = overlayCanvas.getContext('2d');

                                                                                                                                                                                                                                                                                                                                                                                                                                   const prevBtn = document.getElementById('prevBtn');
                                                                                                                                                                                                                                                                                                                                                                                                                                       const nextBtn = document.getElementById('nextBtn');
                                                                                                                                                                                                                                                                                                                                                                                                                                           const undoBtn = document.getElementById('undoBtn');
                                                                                                                                                                                                                                                                                                                                                                                                                                               const redoBtn = document.getElementById('redoBtn');
                                                                                                                                                                                                                                                                                                                                                                                                                                                   const addTextBtn = document.getElementById('addTextBtn');
                                                                                                                                                                                                                                                                                                                                                                                                                                                       const signBtn = document.getElementById('signBtn');
                                                                                                                                                                                                                                                                                                                                                                                                                                                           const saveBtn = document.getElementById('saveBtn');

                                                                                                                                                                                                                                                                                                                                                                                                                                                               const fontSelect = document.getElementById('fontSelect');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                   const fontSizeInput = document.getElementById('fontSizeInput');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                       const boldCheck = document.getElementById('boldCheck');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                           const underlineCheck = document.getElementById('underlineCheck');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                               const highlightCheck = document.getElementById('highlightCheck');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   const textColorInput = document.getElementById('textColorInput');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       const underlineColorInput = document.getElementById('underlineColorInput');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           const highlightColorInput = document.getElementById('highlightColorInput');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               const textStyleBar = document.getElementById('textStyleBar');

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   /* --------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          UI Enable / Disable
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              -------------------------------------------------- */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  function enableControls() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        [prevBtn, nextBtn, addTextBtn, signBtn, saveBtn, undoBtn].forEach(b => b.disabled = false);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              textStyleBar.classList.remove('opacity-50', 'pointer-events-none');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      function updateUndoRedo() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            undoBtn.disabled = undoStack.length === 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  redoBtn.disabled = redoStack.length === 0;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          /* --------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Autosave
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     -------------------------------------------------- */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         function saveState() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if (!originalBytes) return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     idbKeyval.set(STORAGE_KEY, {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             pdf: buf2b64(originalBytes),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     annotations,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             signatures,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     currentPage,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           }).catch(console.error);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   const clearState = () => idbKeyval.del(STORAGE_KEY).catch(console.error);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       /* --------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              Rendering
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  -------------------------------------------------- */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      async function renderPage() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const page = await pdfDoc.getPage(currentPage);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const vp = page.getViewport({ scale });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        pdfCanvas.width = vp.width;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              pdfCanvas.height = vp.height;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    overlayCanvas.width = vp.width;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          overlayCanvas.height = vp.height;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                overlayCtx.clearRect(0,0,overlayCanvas.width, overlayCanvas.height);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      await page.render({ canvasContext: pdfCanvas.getContext('2d'), viewport: vp }).promise;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            drawOverlays();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  saveState();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          function drawOverlays() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                overlayCtx.clearRect(0,0,overlayCanvas.width, overlayCanvas.height);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      annotations.forEach(a => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (a.page !== currentPage) return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const x = a.xNorm * overlayCanvas.width;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const y = a.yNorm * overlayCanvas.height;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      overlayCtx.font = `${a.bold ? '700' : '400'} ${a.fontSize}px ${a.fontFamily}`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              overlayCtx.textBaseline = 'top';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const metrics = overlayCtx.measureText(a.text);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const widthPx = metrics.width;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const heightPx = a.fontSize * 1.2;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if (a.highlight) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        overlayCtx.fillStyle = a.highlightColor;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  overlayCtx.fillRect(x, y, widthPx, heightPx);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  overlayCtx.fillStyle = a.textColor;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          overlayCtx.fillText(a.text, x, y);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  if (a.underline) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            overlayCtx.strokeStyle = a.underlineColor;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      overlayCtx.lineWidth = 1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                overlayCtx.beginPath();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          overlayCtx.moveTo(x, y + a.fontSize + 2);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    overlayCtx.lineTo(x + widthPx, y + a.fontSize + 2);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              overlayCtx.stroke();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  signatures.forEach(s => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          if (s.page !== currentPage) return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  const img = new Image();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          img.onload = () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    overlayCtx.drawImage(img, s.xNorm * overlayCanvas.width, s.yNorm * overlayCanvas.height, s.wNorm * overlayCanvas.width, s.hNorm * overlayCanvas.height);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    img.src = s.sigDataUrl;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  /* --------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         File Handling
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             -------------------------------------------------- */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 chooseBtn.onclick = () => fileInput.click();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     fileInput.onchange = (e) => e.target.files[0] && handleFile(e.target.files[0]);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         function setupDnD() {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               ['dragenter','dragover'].forEach(evt => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       viewer.addEventListener(evt, e => { e.preventDefault(); viewer.classList.add('border-blue-500'); dropHint.classList.remove('hidden'); });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ['dragleave','dragend'].forEach(evt => viewer.addEventListener(evt, () => { viewer.classList.remove('border-blue-500'); dropHint.classList.add('hidden'); }));
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         viewer.addEventListener('drop', e => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 e.preventDefault(); viewer.classList.remove('border-blue-500'); dropHint.classList.add('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         const f = e.dataTransfer.files[0]; if (f && f.type === 'application/pdf') handleFile(f);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   } setupDnD();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       async function handleFile(file) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             originalBytes = await file.arrayBuffer();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   pdfDoc = await pdfjsLib.getDocument({ data: originalBytes }).promise;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         totalPages = pdfDoc.numPages; currentPage = 1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               enableControls(); await renderPage();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       /* --------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              Navigation
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  -------------------------------------------------- */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      prevBtn.onclick = async () => { if (currentPage>1){currentPage--;await renderPage();} };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          nextBtn.onclick = async () => { if (currentPage<totalPages){currentPage++;await renderPage();} };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              /* --------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     Undo / Redo
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         -------------------------------------------------- */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             function pushAction(type,obj){ undoStack.push({type,obj}); redoStack.length=0; updateUndoRedo(); }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 undoBtn.onclick = () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if(!undoStack.length) return; const act = undoStack.pop();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             if(act.type==='annotation') annotations.pop(); else signatures.pop();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   redoStack.push(act); updateUndoRedo(); drawOverlays(); saveState();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           redoBtn.onclick = () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 if(!redoStack.length) return; const act = redoStack.pop();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if(act.type==='annotation') annotations.push(act.obj); else signatures.push(act.obj);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             undoStack.push(act); updateUndoRedo(); drawOverlays(); saveState();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     /* --------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            Add Text
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                -------------------------------------------------- */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    let textMode = false; addTextBtn.onclick = () => { textMode=!textMode; addTextBtn.classList.toggle('ring-2',textMode); overlayCanvas.style.cursor=textMode?'crosshair':'default'; };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        overlayCanvas.addEventListener('click', e => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if(!textMode) return; const txt = prompt('Enter text'); if(!txt) return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const rect = overlayCanvas.getBoundingClientRect();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          const x = e.clientX - rect.left; const y = e.clientY - rect.top;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const fontFamily = fontSelect.value; const fontSize = parseInt(fontSizeInput.value)||16; const bold = boldCheck.checked;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const underline = underlineCheck.checked; const highlight = highlightCheck.checked;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const textColor = textColorInput.value; const underlineColor = underlineColorInput.value; const highlightColor = highlightColorInput.value;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  overlayCtx.font = `${bold?'700':'400'} ${fontSize}px ${fontFamily}`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const widthPx = overlayCtx.measureText(txt).width; const heightPx = fontSize*1.2;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const ann = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      page:currentPage, text:txt, xNorm:x/overlayCanvas.width, yNorm:y/overlayCanvas.height,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              widthNorm:widthPx/overlayCanvas.width, heightNorm:heightPx/overlayCanvas.height,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      fontFamily, fontSize, bold, underline, highlight, textColor, underlineColor, highlightColor
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  annotations.push(ann); pushAction('annotation',ann); drawOverlays(); saveState();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          /* --------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 Signature
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     -------------------------------------------------- */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         const sigModal=document.getElementById('sigModal'); const sigPadCanvas=document.getElementById('sigPad'); const signaturePad=new SignaturePad(sigPadCanvas,{backgroundColor:'rgba(0,0,0,0)'});
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             const resizer=()=>{sigPadCanvas.width=sigPadCanvas.offsetWidth; sigPadCanvas.height=sigPadCanvas.offsetHeight; signaturePad.clear();};
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 window.addEventListener('resize',resizer); resizer();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     signBtn.onclick=()=>sigModal.classList.remove('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         document.getElementById('clearSig').onclick=()=>signaturePad.clear();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             document.getElementById('cancelSig').onclick=()=>sigModal.classList.add('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 document.getElementById('saveSig').onclick=()=>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if(signaturePad.isEmpty()){alert('Draw something');return;}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             const dataUrl=signaturePad.toDataURL(); sigModal.classList.add('hidden');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   const handler=e=>{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           const rect=overlayCanvas.getBoundingClientRect(); const x=e.clientX-rect.left; const y=e.clientY-rect.top;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   const w=100, h=40; const sigObj={page:currentPage,sigDataUrl:dataUrl,xNorm:x/overlayCanvas.width,yNorm:y/overlayCanvas.height,wNorm:w/overlayCanvas.width,hNorm:h/overlayCanvas.height};
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           signatures.push(sigObj); pushAction('signature',sigObj); drawOverlays(); saveState(); overlayCanvas.removeEventListener('click',handler);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }; overlayCanvas.addEventListener('click',handler);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         /* --------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Save
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    -------------------------------------------------- */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        saveBtn.onclick = async () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              if(!originalBytes) return; const pdfLibDoc = await PDFLib.PDFDocument.load(originalBytes); const fontCache={};
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    async function getFont(fam,bold){ const key=`${fam}-${bold}`; if(fontCache[key]) return fontCache[key]; let f;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if(fam==='Helvetica'){f=await pdfLibDoc.embedFont(bold?PDFLib.StandardFonts.HelveticaBold:PDFLib.StandardFonts.Helvetica);} else if(FONT_URLS[fam]){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const url = bold?FONT_URLS[fam].bold:FONT_URLS[fam].regular; const bytes=await fetch(url).then(r=>r.arrayBuffer()); f=await pdfLibDoc.embedFont(bytes,{subset:true});
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              }else{f=await pdfLibDoc.embedFont(PDFLib.StandardFonts.Helvetica);} fontCache[key]=f; return f; }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for(const a of annotations){
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const pg=pdfLibDoc.getPage(a.page-1); const {width:pw,height:ph}=pg.getSize();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const x=a.xNorm*pw; const y=(1-a.yNorm)*ph; const font=await getFont(a.fontFamily,a.bold);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const clr=hexToRgb(a.textColor);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    pg.drawText(a.text,{x,y:a.underline?y-a.fontSize:y-a.fontSize, size:a.fontSize, font, color:PDFLib.rgb(clr.r,clr.g,clr.b)});
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const textWidth=font.widthOfTextAtSize(a.text,a.fontSize); const hPdf=a.heightNorm*ph;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if(a.highlight){ const hclr=hexToRgb(a.highlightColor); pg.drawRectangle({x,y:y-hPdf+4,width:textWidth,height:hPdf,color:PDFLib.rgb(hclr.r,hclr.g,hclr.b)}); }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if(a.underline){ const uclr=hexToRgb(a.underlineColor); pg.drawLine({start:{x,y:y-2},end:{x:x+textWidth,y:y-2},thickness:1,color:PDFLib.rgb(uclr.r,uclr.g,uclr.b)}); }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for(const s of signatures){ const pg=pdfLibDoc.getPage(s.page-1); const {width:pw,height:ph}=pg.getSize();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const imgBytes=await fetch(s.sigDataUrl).then(r=>r.arrayBuffer()); const img=await pdfLibDoc.embedPng(imgBytes);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        pg.drawImage(img,{x:s.xNorm*pw,y:(1-s.yNorm-s.hNorm)*ph,width:s.wNorm*pw,height:s.hNorm*ph}); }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              const outBytes=await pdfLibDoc.save(); const blob=new Blob([outBytes],{type:'application/pdf'});
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='edited.pdf'; a.click(); await clearState();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            /* --------------------------------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   Restore autosave
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       -------------------------------------------------- */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           window.addEventListener('DOMContentLoaded', async () => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 const data = await idbKeyval.get(STORAGE_KEY); if(!data) return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if(!confirm('Recover unsaved PDF edits?')){ await clearState(); return; }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             originalBytes=b642buf(data.pdf); annotations.push(...(data.annotations||[])); signatures.push(...(data.signatures||[])); currentPage=data.currentPage||1;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   pdfDoc=await pdfjsLib.getDocument({data:originalBytes}).promise; totalPages=pdfDoc.numPages; enableControls(); await renderPage();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </script></body>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         </html>